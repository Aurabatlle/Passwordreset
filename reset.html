<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Aura Battle â€” Set New Password</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root {
    --red: #E8192C;
    --red-dim: #9b1020;
    --black: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --text: #f0f0f0;
    --muted: #777;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--black);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  header {
    width: 100%; padding: 18px 24px;
    display: flex; align-items: center; gap: 14px;
    border-bottom: 1px solid var(--border);
    position: relative; z-index: 1;
  }
  .logo-rect {
    width: 48px; height: 32px;
    background: var(--red);
    display: flex; align-items: center; justify-content: center;
    clip-path: polygon(0 0, 100% 0, 100% 75%, 88% 100%, 0 100%);
    flex-shrink: 0;
  }
  .logo-rect span {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px; letter-spacing: 1px;
    color: #fff; line-height: 1;
  }
  .brand {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px; letter-spacing: 2px;
    color: var(--text);
  }
  .brand em { color: var(--red); font-style: normal; }

  main {
    width: 100%; max-width: 440px;
    padding: 40px 24px 60px;
    position: relative; z-index: 1;
    animation: fadeUp .5s ease both;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(24px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .eyebrow {
    font-size: 11px; letter-spacing: 3px; text-transform: uppercase;
    color: var(--red); margin-bottom: 8px;
  }
  h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(36px, 9vw, 52px);
    line-height: .95; letter-spacing: 1px;
    margin-bottom: 12px;
  }
  h1 span { color: var(--red); }
  .subtitle {
    font-size: 14px; color: var(--muted); line-height: 1.6;
    margin-bottom: 36px;
  }

  /* token invalid state */
  .invalid-state {
    text-align: center; padding: 40px 0;
    display: none;
  }
  .invalid-state .icon {
    font-size: 48px; margin-bottom: 16px;
  }
  .invalid-state p {
    color: var(--muted); font-size: 14px; line-height: 1.6;
    margin-bottom: 20px;
  }
  .invalid-state a {
    color: var(--red); text-decoration: none;
    font-weight: 600;
  }

  .field { margin-bottom: 20px; position: relative; }
  label {
    display: block; font-size: 11px; letter-spacing: 2px;
    text-transform: uppercase; color: var(--muted);
    margin-bottom: 8px;
  }
  .pw-wrap { position: relative; }
  input[type=password], input[type=text].pw {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 15px;
    padding: 14px 46px 14px 16px;
    outline: none;
    transition: border-color .2s;
  }
  input:focus { border-color: var(--red); }
  input::placeholder { color: #444; }

  .toggle-pw {
    position: absolute; right: 14px; top: 50%;
    transform: translateY(-50%);
    background: none; border: none;
    color: var(--muted); cursor: pointer;
    font-size: 16px; padding: 4px;
    transition: color .2s;
  }
  .toggle-pw:hover { color: var(--text); }

  /* strength meter */
  .strength-bar {
    height: 3px; border-radius: 2px;
    background: var(--border); margin-top: 8px;
    overflow: hidden;
  }
  .strength-fill {
    height: 100%; border-radius: 2px;
    width: 0; transition: width .3s, background .3s;
  }
  .strength-label {
    font-size: 11px; color: var(--muted);
    margin-top: 4px; height: 16px;
  }

  .btn {
    width: 100%; padding: 15px;
    background: var(--red);
    border: none; border-radius: 4px;
    color: #fff;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px; letter-spacing: 2px;
    cursor: pointer;
    transition: background .2s, transform .1s;
    margin-top: 8px;
    position: relative; overflow: hidden;
  }
  .btn:hover  { background: #ff2236; }
  .btn:active { transform: scale(.98); }
  .btn:disabled { background: var(--red-dim); cursor: not-allowed; }

  .msg {
    margin-top: 20px; padding: 14px 16px;
    border-radius: 4px; font-size: 14px;
    line-height: 1.5; display: none;
  }
  .msg.success { background: #0d2b1a; border: 1px solid #1a5c34; color: #4cde8a; }
  .msg.error   { background: #2b0d0d; border: 1px solid #5c1a1a; color: #ff6b6b; }
  .msg.show    { display: block; animation: fadeUp .3s ease; }

  /* timer bar */
  .timer-bar {
    width: 100%; height: 3px;
    background: var(--border); border-radius: 2px;
    margin-bottom: 28px; overflow: hidden;
  }
  .timer-fill {
    height: 100%; background: var(--red);
    border-radius: 2px;
    transition: width 1s linear, background 1s;
  }
  .timer-label {
    font-size: 12px; color: var(--muted);
    margin-bottom: 28px; margin-top: -20px;
  }

  .spinner {
    width: 18px; height: 18px;
    border: 2px solid rgba(255,255,255,.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin .7s linear infinite;
    display: inline-block; vertical-align: middle;
    margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  footer {
    margin-top: auto; padding: 24px;
    font-size: 12px; color: #333;
    text-align: center; z-index: 1;
  }
</style>
</head>
<body>

<header>
  <div class="logo-rect"><span>AB</span></div>
  <div class="brand">AURA <em>BATTLE</em></div>
</header>

<main>
  <p class="eyebrow">Account Security</p>
  <h1>SET NEW<br/><span>PASSWORD</span></h1>

  <!-- invalid / expired token state -->
  <div class="invalid-state" id="invalidState">
    <div class="icon">ğŸ”’</div>
    <p id="invalidMsg">This reset link is invalid or has expired.<br/>Links are valid for 1 hour only.</p>
    <a href="index.html">â† Request a new link</a>
  </div>

  <!-- valid token: show form -->
  <div id="formWrap">
    <p class="subtitle">Your link is valid. Choose a strong new password for your account.</p>

    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
    <p class="timer-label" id="timerLabel">Link expires in ...</p>

    <form id="pwForm" autocomplete="off">
      <div class="field">
        <label for="pw1">New Password</label>
        <div class="pw-wrap">
          <input type="password" id="pw1" class="pw" placeholder="Min. 6 characters" autocomplete="new-password"/>
          <button type="button" class="toggle-pw" onclick="togglePw('pw1',this)">ğŸ‘</button>
        </div>
        <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
        <div class="strength-label" id="strengthLabel"></div>
      </div>
      <div class="field">
        <label for="pw2">Confirm Password</label>
        <div class="pw-wrap">
          <input type="password" id="pw2" class="pw" placeholder="Repeat your password" autocomplete="new-password"/>
          <button type="button" class="toggle-pw" onclick="togglePw('pw2',this)">ğŸ‘</button>
        </div>
      </div>
      <button type="submit" class="btn" id="saveBtn">SAVE NEW PASSWORD</button>
    </form>

    <div class="msg" id="statusMsg"></div>
  </div>
</main>

<footer>Â© 2025 Aura Battle. All rights reserved.</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyD7pAsdYqkJzDbSsi8xbLsy2X5s0bgP040",
  authDomain: "aura-battle-main.firebaseapp.com",
  databaseURL: "https://aura-battle-main-default-rtdb.firebaseio.com",
  projectId: "aura-battle-main",
  storageBucket: "aura-battle-main.firebasestorage.app",
  messagingSenderId: "763779990289",
  appId: "1:763779990289:web:5caa7bc861e80b6f0b02b0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const SECRET      = "aura_battle_reset_2025";   // must match index.html
const EXPIRY_MS   = 60 * 60 * 1000;             // 1 hour

// â”€â”€ Parse & verify token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function verifyToken(token) {
  try {
    const [b64, sigHex] = token.split('.');
    if (!b64 || !sigHex) return null;

    // restore base64 padding
    const padded  = b64.replace(/-/g,'+').replace(/_/g,'/') + '=='.slice((b64.length+2)%4||2);
    const payload = atob(padded);                  // "userId:email:timestamp"
    const parts   = payload.split(':');
    if (parts.length < 3) return null;

    const [userId, email, tsStr] = parts;
    const ts = parseInt(tsStr, 10);

    // check expiry
    if (Date.now() - ts > EXPIRY_MS) return { expired: true };

    // verify HMAC
    const key = await crypto.subtle.importKey(
      "raw", new TextEncoder().encode(SECRET),
      { name: "HMAC", hash: "SHA-256" }, false, ["verify"]
    );
    const sigBytes = new Uint8Array(sigHex.match(/../g).map(h => parseInt(h,16)));
    const valid    = await crypto.subtle.verify("HMAC", key, sigBytes, new TextEncoder().encode(b64));
    if (!valid) return null;

    return { userId, email, ts };
  } catch { return null; }
}

// â”€â”€ Timer display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimer(ts) {
  const fill  = document.getElementById("timerFill");
  const label = document.getElementById("timerLabel");

  function tick() {
    const elapsed = Date.now() - ts;
    const left    = EXPIRY_MS - elapsed;
    if (left <= 0) {
      fill.style.width      = "0%";
      fill.style.background = "#ff2236";
      label.textContent     = "Link expired.";
      document.getElementById("saveBtn").disabled = true;
      showMsg("This link has expired. Please request a new one.", "error");
      return;
    }
    const pct = ((EXPIRY_MS - left) / EXPIRY_MS) * 100;
    fill.style.width      = `${100 - pct}%`;
    fill.style.background = left < 600000 ? "#ff7c00" : "var(--red)";
    const mins = Math.floor(left / 60000);
    const secs = Math.floor((left % 60000) / 1000);
    label.textContent = `Link expires in ${mins}m ${secs}s`;
    setTimeout(tick, 1000);
  }
  tick();
}

// â”€â”€ Password strength â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("pw1").addEventListener("input", function() {
  const v   = this.value;
  const fill  = document.getElementById("strengthFill");
  const label = document.getElementById("strengthLabel");
  let score = 0;
  if (v.length >= 6)  score++;
  if (v.length >= 10) score++;
  if (/[A-Z]/.test(v)) score++;
  if (/[0-9]/.test(v)) score++;
  if (/[^A-Za-z0-9]/.test(v)) score++;
  const map = [
    { w:"0%",   c:"var(--border)", t:"" },
    { w:"20%",  c:"#ff2236",       t:"Very weak" },
    { w:"40%",  c:"#ff7c00",       t:"Weak" },
    { w:"60%",  c:"#ffd000",       t:"Fair" },
    { w:"80%",  c:"#8bdb41",       t:"Strong" },
    { w:"100%", c:"#4cde8a",       t:"Very strong" },
  ];
  fill.style.width      = map[score].w;
  fill.style.background = map[score].c;
  label.style.color     = map[score].c;
  label.textContent     = map[score].t;
});

// â”€â”€ Toggle visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePw(id, btn) {
  const el = document.getElementById(id);
  if (el.type === "password") { el.type = "text";     btn.textContent = "ğŸ™ˆ"; }
  else                        { el.type = "password"; btn.textContent = "ğŸ‘"; }
}

// â”€â”€ Status msg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMsg(text, type) {
  const el = document.getElementById("statusMsg");
  el.textContent = text;
  el.className   = `msg ${type} show`;
}

// â”€â”€ Token key: short hash used as Firebase key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tokenKey(token) {
  // use first 32 chars of the signature part as a safe Firebase key
  return "rt_" + token.split('.')[1].substring(0, 32);
}

// â”€â”€ Init: verify token from URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tokenData = null;
let rawToken  = null;

(async () => {
  const params = new URLSearchParams(location.search);
  rawToken     = params.get("t");

  function showInvalid(msg) {
    document.getElementById("formWrap").style.display     = "none";
    document.getElementById("invalidState").style.display = "block";
    document.getElementById("invalidMsg").textContent     = msg;
  }

  if (!rawToken) { showInvalid("No reset token found in this link."); return; }

  tokenData = await verifyToken(rawToken);

  if (!tokenData) { showInvalid("This reset link is invalid or has been tampered with."); return; }
  if (tokenData.expired) { showInvalid("This reset link has expired. Links are valid for 1 hour only."); return; }

  // â”€â”€ Check if already used (saved in Firebase under resetTokens/) â”€â”€
  const key      = tokenKey(rawToken);
  const usedSnap = await db.ref(`resetTokens/${key}`).get();
  if (usedSnap.exists()) {
    showInvalid("This reset link has already been used. Please request a new one.");
    return;
  }

  // valid & unused â€” show form and start timer
  startTimer(tokenData.ts);
})();

// â”€â”€ Save new password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("pwForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!tokenData) return;

  const pw1 = document.getElementById("pw1").value;
  const pw2 = document.getElementById("pw2").value;

  if (pw1.length < 6) { showMsg("Password must be at least 6 characters.", "error"); return; }
  if (pw1 !== pw2)    { showMsg("Passwords do not match.", "error"); return; }

  const btn = document.getElementById("saveBtn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>SAVING...';

  try {
    // verify user still exists
    const snap = await db.ref(`users/${tokenData.userId}`).get();
    if (!snap.exists()) {
      showMsg("Account not found. It may have been deleted.", "error");
      btn.disabled = false; btn.textContent = "SAVE NEW PASSWORD"; return;
    }

    // â”€â”€ Double-check token not used between page load and submit â”€â”€
    const key      = tokenKey(rawToken);
    const usedSnap = await db.ref(`resetTokens/${key}`).get();
    if (usedSnap.exists()) {
      showMsg("This link was already used. Please request a new reset link.", "error");
      btn.disabled = false; btn.textContent = "SAVE NEW PASSWORD"; return;
    }

    // â”€â”€ Save new password + mark token as used (atomic) â”€â”€
    await Promise.all([
      db.ref(`users/${tokenData.userId}`).update({ password: pw1 }),
      db.ref(`resetTokens/${key}`).set({
        usedAt: Date.now(),
        userId: tokenData.userId
      })
    ]);

    showMsg("âœ“ Password updated! You can now log in with your new password.", "success");
    btn.disabled    = true;
    btn.textContent = "PASSWORD SAVED";
    document.getElementById("timerLabel").textContent = "";

  } catch (err) {
    console.error(err);
    showMsg("Failed to update password. Please try again.", "error");
    btn.disabled = false; btn.textContent = "SAVE NEW PASSWORD";
  }
});
</script>
</body>
</html>
