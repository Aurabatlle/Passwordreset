<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Aura Battle ‚Äî Password Reset</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root {
    --red: #E8192C;
    --red-dim: #9b1020;
    --black: #0a0a0a;
    --surface: #111111;
    --border: #2a2a2a;
    --text: #f0f0f0;
    --muted: #888;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--black);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header {
    width: 100%; padding: 16px 24px;
    display: flex; align-items: center; gap: 12px;
    border-bottom: 1px solid var(--border);
  }
  header img { height: 36px; width: auto; object-fit: contain; }
  .logo-fallback {
    width: 48px; height: 32px; background: var(--red);
    display: flex; align-items: center; justify-content: center;
    clip-path: polygon(0 0,100% 0,100% 75%,88% 100%,0 100%);
    flex-shrink: 0;
  }
  .logo-fallback span {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px; color: #fff; letter-spacing: 1px;
  }

  main {
    width: 100%; max-width: 420px;
    padding: 40px 24px 60px;
    animation: fadeUp .4s ease both;
  }
  @keyframes fadeUp {
    from { opacity:0; transform:translateY(20px); }
    to   { opacity:1; transform:translateY(0); }
  }

  .eyebrow {
    font-size: 11px; letter-spacing: 3px; text-transform: uppercase;
    color: var(--red); margin-bottom: 8px;
  }
  h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(34px, 9vw, 48px);
    line-height: .95; margin-bottom: 16px;
  }
  h1 span { color: var(--red); }

  /* ‚îÄ‚îÄ highlighted instruction box ‚îÄ‚îÄ */
  .info-box {
    background: #1a0d0d;
    border: 1px solid var(--red);
    border-left: 4px solid var(--red);
    border-radius: 4px;
    padding: 14px 16px;
    margin-bottom: 28px;
  }
  .info-box p {
    font-size: 14px; color: #f0f0f0; line-height: 1.7; margin: 0;
  }
  .info-box strong { color: var(--red); }

  .field { margin-bottom: 20px; }
  label {
    display: block; font-size: 11px; letter-spacing: 2px;
    text-transform: uppercase; color: var(--muted); margin-bottom: 7px;
  }
  input[type=text] {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 16px;
    padding: 14px 16px;
    outline: none;
    transition: border-color .2s;
    -webkit-appearance: none;
  }
  input[type=text]:focus { border-color: var(--red); }
  input::placeholder { color: #444; }

  .hint { font-size: 12px; color: var(--muted); margin-top: 6px; line-height: 1.5; }

  .btn {
    width: 100%; padding: 15px;
    background: var(--red);
    border: none; border-radius: 4px;
    color: #fff;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px; letter-spacing: 2px;
    cursor: pointer;
    transition: background .2s, transform .1s;
    margin-top: 4px;
  }
  .btn:hover   { background: #ff2236; }
  .btn:active  { transform: scale(.98); }
  .btn:disabled { background: var(--red-dim); cursor: not-allowed; }

  .msg {
    margin-top: 18px; padding: 14px 16px;
    border-radius: 4px; font-size: 14px;
    line-height: 1.6; display: none;
  }
  .msg.success { background:#0d2b1a; border:1px solid #1a5c34; color:#4cde8a; }
  .msg.error   { background:#2b0d0d; border:1px solid #5c1a1a; color:#ff6b6b; }
  .msg.show    { display:block; animation:fadeUp .3s ease; }

  .spinner {
    width:17px; height:17px;
    border:2px solid rgba(255,255,255,.3);
    border-top-color:#fff; border-radius:50%;
    animation:spin .7s linear infinite;
    display:inline-block; vertical-align:middle; margin-right:8px;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  footer {
    margin-top:auto; padding:24px;
    font-size:12px; color:#333; text-align:center;
  }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Aura Battle"
       onerror="this.style.display='none';document.getElementById('logoFallback').style.display='flex'"/>
  <div class="logo-fallback" id="logoFallback" style="display:none"><span>AB</span></div>
</header>

<main>
  <p class="eyebrow">Account Security</p>
  <h1>RESET YOUR<br/><span>PASSWORD</span></h1>

  <!-- Highlighted instruction -->
  <div class="info-box">
    <p>You can enter your:<br/>
      <strong>üì± Mobile Number</strong> ‚Äî 10 digits (e.g. 9876543210)<br/>
      <strong>üìß Email Address</strong> ‚Äî e.g. <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fc96939492bc9b919d9590d29f9391">[email&#160;protected]</a><br/>
      <strong>ü™™ User ID</strong> ‚Äî 6 characters (e.g. ABC123)
    </p>
  </div>

  <form id="resetForm" autocomplete="off">
    <div class="field">
      <label for="identifier">Mobile / Email / User ID</label>
      <input type="text" id="identifier"
             placeholder="Enter mobile, email or User ID"
             autocomplete="off"
             autocorrect="off"
             spellcheck="false"/>
      <p class="hint">We'll send a reset link to your registered email address.</p>
    </div>
    <button type="submit" class="btn" id="submitBtn">SEND RESET LINK</button>
  </form>

  <div class="msg" id="statusMsg"></div>
</main>

<footer>¬© 2025 Aura Battle. All rights reserved.</footer>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2uVMvG-P2Vq0W9cZ8xpEHhS9jdeZ-g_XXDdyMJpQdnYgSrnC8M3ZtqPwkIO1D4uP2cQ/exec";
const SITE_URL        = "https://resetpassword-aurabattle.netlify.app";
const SECRET          = "aura_battle_reset_2025"; // must match reset.html

firebase.initializeApp({
  apiKey: "AIzaSyD7pAsdYqkJzDbSsi8xbLsy2X5s0bgP040",
  authDomain: "aura-battle-main.firebaseapp.com",
  databaseURL: "https://aura-battle-main-default-rtdb.firebaseio.com",
  projectId: "aura-battle-main",
  storageBucket: "aura-battle-main.firebasestorage.app",
  messagingSenderId: "763779990289",
  appId: "1:763779990289:web:5caa7bc861e80b6f0b02b0"
});
const db = firebase.database();

// ‚îÄ‚îÄ Auto-uppercase only if it's a pure letter/number ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("identifier").addEventListener("input", function() {
  const v = this.value;
  // only uppercase if no @ (not an email) and no spaces
  if (!v.includes("@") && !v.includes(" ")) {
    const pos = this.selectionStart;
    this.value = v.toUpperCase();
    this.setSelectionRange(pos, pos);
  }
});

// ‚îÄ‚îÄ Find user ‚Äî scans all users (works without Firebase index) ‚îÄ‚îÄ‚îÄ‚îÄ
async function findUser(raw) {
  const val    = raw.trim();
  const upper  = val.toUpperCase();
  const digits = val.replace(/\D/g, '');

  // 1 ‚îÄ‚îÄ User ID: direct lookup (fastest, no scan)
  if (!val.includes("@") && digits.length !== 10) {
    try {
      const snap = await db.ref("users").child(upper).get();
      if (snap.exists()) {
        const d = snap.val();
        if (!d.email) return { error: "no_email" };
        return { userId: upper, email: d.email, name: d.name || "" };
      }
    } catch(e) { console.error("userId lookup error:", e); }
    return null;
  }

  // 2 ‚îÄ‚îÄ Email or Phone: scan all users and match locally
  try {
    const snap = await db.ref("users").get();
    if (!snap.exists()) return null;

    const allUsers = snap.val();
    for (const userId in allUsers) {
      const d = allUsers[userId];

      // Email match (case-insensitive)
      if (val.includes("@")) {
        if (d.email && d.email.toLowerCase() === val.toLowerCase()) {
          return { userId, email: d.email, name: d.name || "" };
        }
        continue;
      }

      // Phone match (compare 10 digits)
      if (digits.length === 10) {
        const storedDigits = (d.phone || "").replace(/\D/g, '');
        if (storedDigits === digits) {
          if (!d.email) return { error: "no_email" };
          return { userId, email: d.email, name: d.name || "" };
        }
      }
    }
  } catch(e) {
    console.error("scan error:", e);
    return { error: "scan_failed" };
  }

  return null;
}

// ‚îÄ‚îÄ Generate HMAC token ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateToken(userId, email) {
  const payload = `${userId}:${email}:${Date.now()}`;
  const b64     = btoa(payload);
  const key     = await crypto.subtle.importKey(
    "raw", new TextEncoder().encode(SECRET),
    { name:"HMAC", hash:"SHA-256" }, false, ["sign"]
  );
  const sig    = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(b64));
  const sigHex = Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join('');
  return `${b64.replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_')}.${sigHex}`;
}

function showMsg(text, type) {
  const el = document.getElementById("statusMsg");
  el.innerHTML = text;
  el.className = `msg ${type} show`;
}

// ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("resetForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const raw = document.getElementById("identifier").value.trim();
  if (!raw) { showMsg("Please enter your mobile number, email, or User ID.", "error"); return; }

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>SEARCHING...';

  try {
    const user = await findUser(raw);

    if (!user) {
      showMsg("‚ùå No account found. Please check your details and try again.", "error");
      btn.disabled = false; btn.textContent = "SEND RESET LINK"; return;
    }
    if (user.error === "no_email") {
      showMsg("‚ùå This account has no email address linked. Please contact support.", "error");
      btn.disabled = false; btn.textContent = "SEND RESET LINK"; return;
    }
    if (user.error === "invalid_format") {
      showMsg("‚ùå Please enter a valid mobile number, email address, or User ID.", "error");
      btn.disabled = false; btn.textContent = "SEND RESET LINK"; return;
    }
    if (user.error === "scan_failed") {
      showMsg("‚ùå Could not connect to database. Please check your internet and try again.", "error");
      btn.disabled = false; btn.textContent = "SEND RESET LINK"; return;
    }

    btn.innerHTML = '<span class="spinner"></span>SENDING EMAIL...';

    const token    = await generateToken(user.userId, user.email);
    const resetUrl = `${SITE_URL}/reset.html?t=${token}`;

    // no-cors required for Google Apps Script
    await fetch(APPS_SCRIPT_URL, {
      method:  "POST",
      mode:    "no-cors",
      headers: { "Content-Type": "application/json" },
      body:    JSON.stringify({ to: user.email, name: user.name, resetUrl })
    });

    const masked = user.email.replace(/(.{2}).+(@.+)/, '$1****$2');
    showMsg(`‚úÖ Reset link sent to <strong>${masked}</strong>.<br/>Check your inbox and spam folder.`, "success");

  } catch (
