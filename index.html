<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Aura Battle — Password Reset</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root {
    --red: #E8192C;
    --red-dim: #9b1020;
    --black: #0a0a0a;
    --surface: #111111;
    --border: #2a2a2a;
    --text: #f0f0f0;
    --muted: #777;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--black);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header {
    width: 100%; padding: 16px 24px;
    display: flex; align-items: center; gap: 12px;
    border-bottom: 1px solid var(--border);
  }
  header img {
    height: 36px; width: auto;
    object-fit: contain;
  }
  /* fallback if logo.png missing */
  .logo-fallback {
    width: 48px; height: 32px;
    background: var(--red);
    display: flex; align-items: center; justify-content: center;
    clip-path: polygon(0 0, 100% 0, 100% 75%, 88% 100%, 0 100%);
    flex-shrink: 0;
  }
  .logo-fallback span {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px; color: #fff; letter-spacing: 1px;
  }

  main {
    width: 100%; max-width: 420px;
    padding: 40px 24px 60px;
    animation: fadeUp .4s ease both;
  }
  @keyframes fadeUp {
    from { opacity:0; transform:translateY(20px); }
    to   { opacity:1; transform:translateY(0); }
  }

  .eyebrow {
    font-size: 11px; letter-spacing: 3px; text-transform: uppercase;
    color: var(--red); margin-bottom: 8px;
  }
  h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(34px, 9vw, 48px);
    line-height: .95; margin-bottom: 10px;
  }
  h1 span { color: var(--red); }
  .subtitle {
    font-size: 14px; color: var(--muted);
    line-height: 1.6; margin-bottom: 32px;
  }

  .field { margin-bottom: 18px; }
  label {
    display: block; font-size: 11px; letter-spacing: 2px;
    text-transform: uppercase; color: var(--muted); margin-bottom: 7px;
  }
  input[type=text] {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 16px;
    padding: 14px 16px;
    outline: none;
    transition: border-color .2s;
    -webkit-appearance: none;
  }
  input[type=text]:focus { border-color: var(--red); }
  input::placeholder { color: #444; }
  /* number keyboard on mobile */
  input.numeric { inputmode: numeric; }

  .hint { font-size: 12px; color: var(--muted); margin-top: 5px; }

  .btn {
    width: 100%; padding: 15px;
    background: var(--red);
    border: none; border-radius: 4px;
    color: #fff;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px; letter-spacing: 2px;
    cursor: pointer;
    transition: background .2s, transform .1s;
    margin-top: 6px;
  }
  .btn:hover   { background: #ff2236; }
  .btn:active  { transform: scale(.98); }
  .btn:disabled { background: var(--red-dim); cursor: not-allowed; }

  .msg {
    margin-top: 18px; padding: 14px 16px;
    border-radius: 4px; font-size: 14px;
    line-height: 1.5; display: none;
  }
  .msg.success { background:#0d2b1a; border:1px solid #1a5c34; color:#4cde8a; }
  .msg.error   { background:#2b0d0d; border:1px solid #5c1a1a; color:#ff6b6b; }
  .msg.info    { background:#0d1e2b; border:1px solid #1a3d5c; color:#6bc5ff; }
  .msg.show    { display:block; animation:fadeUp .3s ease; }

  .spinner {
    width:17px; height:17px;
    border:2px solid rgba(255,255,255,.3);
    border-top-color:#fff;
    border-radius:50%;
    animation:spin .7s linear infinite;
    display:inline-block; vertical-align:middle; margin-right:8px;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  footer {
    margin-top:auto; padding:24px;
    font-size:12px; color:#333; text-align:center;
  }
</style>
</head>
<body>

<header>
  <!-- Uses logo.png from same folder. Falls back to text logo if missing -->
  <img src="logo.png" alt="Aura Battle" onerror="this.style.display='none';document.getElementById('logoFallback').style.display='flex'"/>
  <div class="logo-fallback" id="logoFallback" style="display:none"><span>AB</span></div>
</header>

<main>
  <p class="eyebrow">Account Security</p>
  <h1>RESET YOUR<br/><span>PASSWORD</span></h1>
  <p class="subtitle">Enter your 10-digit mobile number or 6-character User ID. We'll send a reset link to your registered email.</p>

  <form id="resetForm" autocomplete="off">
    <div class="field">
      <label for="identifier">Mobile Number or User ID</label>
      <input type="text" id="identifier"
             inputmode="text"
             placeholder="9876543210  or  ABC123"
             maxlength="10"
             autocomplete="off"
             autocorrect="off"
             autocapitalize="characters"/>
      <p class="hint">10-digit number (e.g. 9876543210) or 6-character ID (e.g. ABC123)</p>
    </div>
    <button type="submit" class="btn" id="submitBtn">SEND RESET LINK</button>
  </form>

  <div class="msg" id="statusMsg"></div>
</main>

<footer>© 2025 Aura Battle. All rights reserved.</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ── CONFIG — update SITE_URL after Netlify deploy ─────────────────
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHw3wIRzzFlS0EVOsDQ_ZAic0BAGvMC3rPHKT_oL1BjN_Vu2OSS51xi176brUusnRCrA/exec";
const SITE_URL        = "https://YOUR_SITE.netlify.app"; // ← replace after Netlify deploy
const SECRET          = "aura_battle_reset_2025";        // must match reset.html

// ── Firebase ──────────────────────────────────────────────────────
firebase.initializeApp({
  apiKey: "AIzaSyD7pAsdYqkJzDbSsi8xbLsy2X5s0bgP040",
  authDomain: "aura-battle-main.firebaseapp.com",
  databaseURL: "https://aura-battle-main-default-rtdb.firebaseio.com",
  projectId: "aura-battle-main",
  storageBucket: "aura-battle-main.firebasestorage.app",
  messagingSenderId: "763779990289",
  appId: "1:763779990289:web:5caa7bc861e80b6f0b02b0"
});
const db = firebase.database();

// ── Input: auto-uppercase for IDs ─────────────────────────────────
const idInput = document.getElementById("identifier");
idInput.addEventListener("input", function() {
  // if looks like a user ID (has letters), uppercase it
  if (/[a-zA-Z]/.test(this.value)) {
    const pos = this.selectionStart;
    this.value = this.value.toUpperCase();
    this.setSelectionRange(pos, pos);
  }
  // remove maxlength restriction for phone (10) vs id (6)
  this.maxLength = /^\d+$/.test(this.value) ? 10 : 6;
});

// ── Find user: phone OR userId only ──────────────────────────────
async function findUser(raw) {
  const val = raw.trim().toUpperCase();

  // ── 1. Looks like 10-digit phone ──
  const digits = raw.replace(/\D/g, '');
  if (digits.length === 10) {
    const snap = await db.ref("users").orderByChild("phone").equalTo(digits).get();
    if (snap.exists()) {
      const key = Object.keys(snap.val())[0];
      const d   = snap.val()[key];
      if (!d.email) return { error: "no_email" };
      return { userId: key, email: d.email, name: d.name || "" };
    }
    return null;
  }

  // ── 2. Looks like 6-char user ID ──
  if (/^[A-Z0-9]{6}$/.test(val)) {
    const snap = await db.ref("users").child(val).get();
    if (snap.exists()) {
      const d = snap.val();
      if (!d.email) return { error: "no_email" };
      return { userId: val, email: d.email, name: d.name || "" };
    }
    return null;
  }

  return { error: "invalid_format" };
}

// ── Generate HMAC token (no DB needed) ───────────────────────────
async function generateToken(userId, email) {
  const payload = `${userId}:${email}:${Date.now()}`;
  const b64     = btoa(payload);
  const key     = await crypto.subtle.importKey(
    "raw", new TextEncoder().encode(SECRET),
    { name:"HMAC", hash:"SHA-256" }, false, ["sign"]
  );
  const sig    = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(b64));
  const sigHex = Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join('');
  return `${b64.replace(/=/g,'').replace(/\+/g,'-').replace(/\//g,'_')}.${sigHex}`;
}

// ── Status message ────────────────────────────────────────────────
function showMsg(text, type) {
  const el = document.getElementById("statusMsg");
  el.innerHTML   = text;
  el.className   = `msg ${type} show`;
}

// ── Submit ────────────────────────────────────────────────────────
document.getElementById("resetForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const raw = idInput.value.trim();
  if (!raw) { showMsg("Please enter your mobile number or User ID.", "error"); return; }

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>CHECKING...';

  try {
    // ── Step 1: verify user exists ──
    const user = await findUser(raw);

    if (!user) {
      showMsg("No account found with that number or ID. Please check and try again.", "error");
      btn.disabled = false; btn.textContent = "SEND RESET LINK"; return;
    }
    if (user.error === "no_email") {
      showMsg("This account has no email address linked. Please contact support.", "error");
      btn.disabled = false; btn.textContent = "SEND RESET LINK"; return;
    }
    if (user.error === "invalid_format") {
      showMsg("Please enter a valid 10-digit mobile number or 6-character User ID.", "error");
      btn.disabled = false; btn.textContent = "SEND RESET LINK"; return;
    }

    // ── Step 2: generate token & send email ──
    btn.innerHTML = '<span class="spinner"></span>SENDING EMAIL...';

    const token    = await generateToken(user.userId, user.email);
    const resetUrl = `${SITE_URL}/reset.html?t=${token}`;

    // Apps Script does not support CORS properly — use no-cors mode
    // Email will still be sent; we just can't read the response
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode:   "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ to: user.email, name: user.name, resetUrl })
    });

    // Since no-cors can't read response, we trust it worked if no exception
    const masked = user.email.replace(/(.{2}).+(@.+)/, '$1****$2');
    showMsg(`✓ Reset link sent to <strong>${masked}</strong>.<br/>Check your inbox and spam folder.`, "success");

  } catch (err) {
    console.error(err);
    showMsg("Something went wrong. Please try again in a moment.", "error");
  }

  btn.disabled = false; btn.textContent = "SEND RESET LINK";
});
</script>
</body>
</html>
